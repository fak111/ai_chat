# A宝 - 开发计划

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v1.2 |
| 创建日期 | 2026-02-05 |
| 更新日期 | 2026-02-05 |
| 来源文档 | FeatureSummary.md, PRD.md, RequirementsDoc.md |
<!-- MODIFIED: 原内容为 "确定技术选型：DeepSeek、Resend、Cloudflare R2、Supabase、Upstash" -->
| 更新说明 | v1.2: 优化 Redis 使用策略，减少对 Upstash 免费额度的依赖 |

## 1. 项目概述

### 1.1 项目目标

| 目标 | 指标 | 衡量方式 |
|------|------|----------|
| MVP 验证 | 完成核心功能开发 | 群聊 + 邮箱登录 + AI交互功能可用 |
| 性能达标 | 消息延迟 < 1秒，AI响应 < 5秒 | 端到端测试 |
| 平台覆盖 | Android 应用上线 | Google Play 发布 |

### 1.2 技术栈

| 层级 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| 移动端 | Flutter | 3.x | 跨平台框架，MVP 先支持 Android，后续扩展 iOS |
| 后端框架 | Spring Boot | 3.x | Java 后端框架，成熟稳定 |
| 实时通信 | WebSocket | - | 消息实时推送 |
| 数据库 | Supabase (PostgreSQL) | 15+ | 主数据库，托管服务，500MB 免费 |
<!-- MODIFIED: 原内容为 "Serverless Redis，10K 请求/天免费" -->
| 缓存 | Upstash (Redis) | 7.x | Serverless Redis，10K 请求/天免费；**采用内存优先策略减少 Redis 调用**（详见 4.5 节） |
| AI 服务 | DeepSeek API | - | 国产 AI 服务，性价比高，兼容 OpenAI 格式 |
| 邮箱服务 | Resend | - | 发送验证邮件，3000 封/月免费 |
| 对象存储 | Cloudflare R2 | - | 头像等静态资源存储，10GB 免费，无出口费 |
| 容器化 | Docker + Railway | - | 服务部署，$5/月免费额度 |

### 1.3 开发原则

| 原则 | 说明 |
|------|------|
| MVP 优先 | 聚焦核心功能，快速验证，避免过度设计 |
| 安全第一 | HTTPS 加密、密码哈希、防暴力破解 |
| 可扩展 | 模块化设计，便于后续功能迭代 |
| 测试驱动 | 关键路径覆盖单元测试和集成测试 |

## 2. 技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Flutter Mobile App                               │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │   用户模块    │  │   群聊模块   │  │   设置模块   │              │   │
│  │  │  登录/注册   │  │  消息收发    │  │  主题/通知   │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                    │ HTTPS              │ WSS (WebSocket Secure)
                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API 网关层                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Nginx / API Gateway                               │   │
│  │  • 负载均衡  • SSL 终止  • 请求路由  • 限流熔断                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              服务层 (Spring Boot)                            │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │   Auth Service │  │   Chat Service │  │    AI Service  │               │
│  │  ────────────  │  │  ────────────  │  │  ────────────  │               │
│  │  • 邮箱注册    │  │  • 群聊管理    │  │  • AI 调用    │               │
│  │  • 邮箱登录    │  │  • 消息收发    │  │  • 上下文管理 │               │
│  │  • Token 管理  │  │  • 邀请码      │  │  • 回复生成   │               │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘               │
│          │                   │                   │                         │
│          └───────────────────┼───────────────────┘                         │
│                              │                                              │
│  ┌───────────────────────────┴───────────────────────────────────────┐    │
│  │                     WebSocket Server                               │    │
│  │  • 连接管理  • 消息广播  • 在线状态  • 心跳检测                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据层                                          │
<!-- MODIFIED: Redis 职责调整，减少依赖 -->
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │   PostgreSQL   │  │  内存 + Redis  │  │   对象存储     │               │
│  │  ────────────  │  │  ────────────  │  │  ────────────  │               │
│  │  • 用户表      │  │  • 在线状态    │  │  • 头像        │               │
│  │  • 群聊表      │  │    (内存优先)  │  │  • 静态资源    │               │
│  │  • 消息表      │  │  • 消息缓存    │  │                │               │
│  │  • 成员表      │  │    (本地+Redis)│  │                │               │
│  │               │  │  • 限流计数    │  │                │               │
│  │               │  │    (仅Redis)   │  │                │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部服务                                        │
│  ┌────────────────┐  ┌────────────────┐                                    │
│  │   邮箱服务     │  │    AI 服务     │                                    │
│  │    Resend     │  │   DeepSeek     │                                    │
│  └────────────────┘  └────────────────┘                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块依赖图

```
                         ┌─────────────────┐
                         │   Auth Module   │
                         │   (认证模块)     │
                         │   F-001~F-003   │
                         └────────┬────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              │                   │                   │
              ▼                   ▼                   ▼
     ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
     │   Chat Module   │ │    AI Module    │ │  Settings Module│
     │   (群聊模块)    │ │   (AI模块)      │ │   (设置模块)    │
     │   F-004~F-010   │ │   F-011~F-013   │ │   F-014~F-015   │
     └────────┬────────┘ └────────┬────────┘ └─────────────────┘
              │                   │
              │    ┌──────────────┘
              │    │
              ▼    ▼
     ┌─────────────────┐
     │  Message Module │
     │   (消息模块)    │
     │  WebSocket 通信 │
     └────────┬────────┘
              │
              ▼
     ┌─────────────────┐
     │   Data Layer    │
     │   (数据层)      │
     │ PostgreSQL+Redis│
     └─────────────────┘
```

**依赖说明**：
- Auth Module 是基础模块，所有业务模块依赖其认证能力
- Chat Module 和 AI Module 共享 Message Module 的消息通道
- Settings Module 相对独立，仅依赖 Auth Module

### 2.3 数据流图

**用户注册流程**：
```
用户 ──▶ 填写邮箱密码 ──▶ API Gateway ──▶ Auth Service ──▶ 校验邮箱格式
                                                │
                                                ▼
                                         检查邮箱是否已注册
                                                │
                                                ▼
                                         邮箱服务 ──▶ 发送验证邮件
                                                │
                                                ▼
用户 ◀── 验证成功 ◀── Auth Service ◀── 用户点击验证链接
                           │
                           ▼
                      PostgreSQL (保存用户)
```

**消息发送流程**：
```
用户 ──▶ 输入消息 ──▶ WebSocket ──▶ Chat Service ──▶ 校验消息
                                           │
                                           ▼
                                    保存到 PostgreSQL
                                           │
                                           ▼
                                    缓存到 Redis
                                           │
                                           ▼
                                    广播到群成员 ──▶ WebSocket ──▶ 其他用户
```

**AI 对话流程**：
```
用户 ──▶ 发送 @AI 消息 ──▶ Chat Service ──▶ 检测 @AI 触发
                                    │
                                    ▼
                              AI Service ──▶ 构建上下文
                                    │
                                    ▼
                              调用 AI API (DeepSeek)
                                    │
                                    ▼
                              生成 AI 回复
                                    │
                                    ▼
                         Chat Service ──▶ 作为群消息广播
                                    │
                                    ▼
                              群内所有成员收到 AI 回复
```

## 3. 开发阶段

### 3.1 阶段时间线

```
     Phase 1              Phase 2              Phase 3
        │                    │                    │
   基础架构+核心功能      功能增强              平台扩展
        │                    │                    │
        ▼                    ▼                    ▼
   ┌──────────┐         ┌──────────┐         ┌──────────┐
   │   MVP    │  ────▶  │   v1.1   │  ────▶  │   v2.0   │
   │  核心功能 │         │  体验优化 │         │  平台扩展 │
   └──────────┘         └──────────┘         └──────────┘

   交付物:               交付物:               交付物:
   • 用户注册/登录       • 历史消息分页        • iOS 版本
   • 群聊创建/加入       • 邀请码分享优化      • 主题色设置
   • 消息收发           • 性能优化            • 消息中心
   • AI 对话功能

   功能覆盖:             功能覆盖:             功能覆盖:
   F-001 ~ F-008        F-009, F-010         F-014, F-015
   F-011 ~ F-013
```

### 3.2 Phase 1: MVP 核心功能

**目标**: 实现核心群聊和 AI 交互功能，完成 Android 应用发布

**优先级**: P0

#### 3.2.1 任务列表

| 任务ID | 任务 | 描述 | 依赖 | 优先级 | 关联功能 |
|--------|------|------|------|--------|----------|
| **基础架构** |
| T-001 | 项目初始化 | 创建 Flutter 项目、Spring Boot 项目、数据库设计 | - | P0 | - |
| T-002 | 基础设施搭建 | Docker 环境、CI/CD 配置、开发环境 | T-001 | P0 | - |
| T-003 | 数据库设计实现 | 用户表、群聊表、消息表、成员表 | T-001 | P0 | - |
| **用户系统** |
| T-004 | 邮箱注册后端 | 注册接口、邮箱验证、密码加密 | T-003 | P0 | F-001 |
| T-005 | 邮箱登录后端 | 登录接口、JWT Token 生成 | T-004 | P0 | F-002 |
| T-006 | 登录态管理 | Token 刷新、自动登录、登出 | T-005 | P0 | F-003 |
| T-007 | 用户系统前端 | 注册页、登录页、Token 存储 | T-006 | P0 | F-001~F-003 |
| **群聊系统** |
| T-008 | 群聊管理后端 | 创建群聊、加入群聊、群聊列表接口 | T-006 | P0 | F-004~F-006 |
| T-009 | WebSocket 服务 | 连接管理、消息广播、心跳机制 | T-008 | P0 | F-007, F-008 |
| T-010 | 消息收发后端 | 消息存储、消息推送、消息查询 | T-009 | P0 | F-007, F-008 |
| T-011 | 群聊系统前端 | 群聊列表页、聊天页、消息输入组件 | T-010 | P0 | F-004~F-008 |
| **AI 系统** |
| T-012 | AI 服务集成 | AI API 对接、调用封装 | T-003 | P0 | F-011~F-013 |
| T-013 | AI 触发逻辑 | @AI 检测、上下文构建、回复生成 | T-012, T-010 | P0 | F-012 |
| T-014 | 引用回复逻辑 | 引用消息解析、上下文拼接 | T-013 | P0 | F-013 |
| T-015 | AI 交互前端 | @AI 输入、AI 消息展示、引用组件 | T-014, T-011 | P0 | F-011~F-013 |
| **测试与发布** |
| T-016 | 集成测试 | 端到端测试、性能测试 | T-015 | P0 | - |
| T-017 | Android 发布 | 打包签名、上架 Google Play | T-016 | P0 | - |

#### 3.2.2 阶段依赖图

```
T-001 ──▶ T-002 ──▶ (基础设施就绪)
  │
  └──▶ T-003 ──▶ T-004 ──▶ T-005 ──▶ T-006 ──▶ T-007
                                        │         │
                                        │         │ (用户系统完成)
                                        ▼         │
                  T-012 ──▶ T-013 ──▶ T-014      │
                              │                   │
                              │                   ▼
                              │         T-008 ──▶ T-009 ──▶ T-010 ──▶ T-011
                              │                                         │
                              │                                         │
                              └─────────────────────────────────────────┤
                                                                        ▼
                                                               T-015 (AI前端)
                                                                        │
                                                                        ▼
                                                               T-016 ──▶ T-017
```

### 3.3 Phase 2: 功能增强

**目标**: 优化用户体验，完善群聊功能

**优先级**: P1

#### 3.3.1 任务列表

| 任务ID | 任务 | 描述 | 依赖 | 优先级 | 关联功能 |
|--------|------|------|------|--------|----------|
| T-018 | 历史消息后端 | 分页查询、滚动加载 | T-017 | P1 | F-009 |
| T-019 | 历史消息前端 | 上滑加载更多、加载状态 | T-018 | P1 | F-009 |
| T-020 | 邀请码功能后端 | 邀请码生成、有效期管理 | T-017 | P1 | F-010 |
| T-021 | 邀请码功能前端 | 邀请码展示、复制分享 | T-020 | P1 | F-010 |
| T-022 | 性能优化 | 消息加载优化、缓存策略 | T-019, T-021 | P1 | - |
| T-023 | v1.1 发布 | 版本更新发布 | T-022 | P1 | - |

#### 3.3.2 阶段依赖图

```
T-017 (MVP发布)
  │
  ├──▶ T-018 ──▶ T-019 ──┐
  │                       │
  └──▶ T-020 ──▶ T-021 ──┤
                          │
                          ▼
                     T-022 ──▶ T-023
```

### 3.4 Phase 3: 平台扩展

**目标**: 扩展 iOS 平台，增加个性化功能

**优先级**: P2

#### 3.4.1 任务列表

| 任务ID | 任务 | 描述 | 依赖 | 优先级 | 关联功能 |
|--------|------|------|------|--------|----------|
| T-024 | iOS 适配 | Flutter iOS 构建、测试 | T-023 | P2 | - |
| T-025 | 主题色后端 | 主题配置存储 | T-023 | P2 | F-014 |
| T-026 | 主题色前端 | 主题选择、实时切换 | T-025 | P2 | F-014 |
| T-027 | 消息中心后端 | 系统通知存储、查询 | T-023 | P2 | F-015 |
| T-028 | 消息中心前端 | 通知列表、未读标记 | T-027 | P2 | F-015 |
| T-029 | iOS 发布 | 上架 App Store | T-024, T-026, T-028 | P2 | - |
| T-030 | v2.0 发布 | Android v2.0 发布 | T-026, T-028 | P2 | - |

#### 3.4.2 阶段依赖图

```
T-023 (v1.1发布)
  │
  ├──▶ T-024 ───────────────────────┐
  │                                  │
  ├──▶ T-025 ──▶ T-026 ──┐          │
  │                       │          │
  └──▶ T-027 ──▶ T-028 ──┤          │
                          │          │
                          ▼          ▼
                     T-030      T-029
                  (Android)    (iOS)
```

## 4. 技术方案

### 4.1 用户系统 (Auth Module)

**功能**: 提供用户注册、登录、认证服务

**关联功能**: F-001 邮箱注册, F-002 邮箱登录, F-003 登录态管理

**技术选型**:

| 组件 | 技术 | 选型理由 |
|------|------|----------|
| 认证框架 | Spring Security | 成熟的安全框架，支持 JWT |
| Token | JWT | 无状态认证，便于分布式扩展 |
| 密码加密 | BCrypt | 安全的密码哈希算法 |
| 邮箱验证 | Resend | API 简洁，3000封/月免费，到达率高 |

**架构设计**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Auth Module                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐      ┌─────────────────┐                      │
│  │  AuthController │ ───▶ │   AuthService   │                      │
│  │  • /register    │      │  • 注册逻辑     │                      │
│  │  • /login       │      │  • 登录逻辑     │                      │
│  │  • /verify      │      │  • Token管理    │                      │
│  │  • /refresh     │      │                 │                      │
│  └─────────────────┘      └────────┬────────┘                      │
│                                    │                                │
│                    ┌───────────────┼───────────────┐               │
│                    ▼               ▼               ▼               │
│           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│           │ UserRepo    │  │ EmailService│  │ TokenService│       │
│           │ (Supabase)  │  │ (Resend)    │  │ (JWT+Redis) │       │
│           └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────────────┘
```

**接口设计**:

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户注册 | POST | /api/auth/register | 邮箱注册，发送验证邮件 |
| 邮箱验证 | POST | /api/auth/verify | 验证邮箱链接中的 Token |
| 用户登录 | POST | /api/auth/login | 邮箱密码登录，返回 JWT |
| Token刷新 | POST | /api/auth/refresh | 刷新 Access Token |
| 用户登出 | POST | /api/auth/logout | 使当前 Token 失效 |

**实现要点**:

- 密码使用 BCrypt 加盐哈希存储，不可逆
- JWT Access Token 有效期 2 小时，Refresh Token 7 天
- 登录失败 5 次锁定账号 30 分钟，防暴力破解
- 邮箱验证链接有效期 24 小时，支持重发

### 4.2 群聊系统 (Chat Module)

**功能**: 提供群聊创建、加入、消息收发服务

**关联功能**: F-004~F-010

**技术选型**:

| 组件 | 技术 | 选型理由 |
|------|------|----------|
| 实时通信 | WebSocket + STOMP | 成熟的实时通信方案 |
| 消息存储 | PostgreSQL | 关系型数据库，保证数据一致性 |
<!-- MODIFIED: 原内容为 "Redis | 热点消息缓存，提升读取性能" -->
| 消息缓存 | Caffeine + Redis | **本地缓存优先**，Redis 作为二级缓存，减少 Redis 调用 |
<!-- MODIFIED: 原内容为 "Redis Pub/Sub | 轻量级消息广播" -->
| 消息广播 | Spring WebSocket | 单实例内存广播，MVP 阶段无需 Redis Pub/Sub |

**架构设计**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Chat Module                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐      ┌─────────────────┐                      │
│  │  ChatController │ ───▶ │   ChatService   │                      │
│  │  • /groups      │      │  • 群聊管理     │                      │
│  │  • /groups/join │      │  • 成员管理     │                      │
│  │  • /groups/{id} │      │  • 邀请码管理   │                      │
│  └─────────────────┘      └────────┬────────┘                      │
│                                    │                                │
│  ┌─────────────────┐               │                                │
│  │WebSocketHandler │               │                                │
│  │  • 连接管理     │               │                                │
│  │  • 消息路由     │               │                                │
│  │  • 心跳检测     │───────────────┤                                │
│  └─────────────────┘               │                                │
│                                    ▼                                │
│                         ┌─────────────────┐                        │
│                         │  MessageService │                        │
│                         │  • 消息存储     │                        │
│                         │  • 消息广播     │                        │
│                         │  • 历史查询     │                        │
│                         └────────┬────────┘                        │
│                    ┌─────────────┼─────────────┐                   │
│                    ▼             ▼             ▼                   │
│           ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│           │  GroupRepo  │ │ MessageRepo │ │ Redis Cache │         │
│           │ (PostgreSQL)│ │ (PostgreSQL)│ │ (消息缓存)  │         │
│           └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────────────┘
```

**接口设计**:

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建群聊 | POST | /api/groups | 创建新群聊，返回群信息 |
| 加入群聊 | POST | /api/groups/join | 通过邀请码加入群聊 |
| 群聊列表 | GET | /api/groups | 获取用户的群聊列表 |
| 群聊详情 | GET | /api/groups/{id} | 获取群聊信息和成员 |
| 获取邀请码 | GET | /api/groups/{id}/invite | 获取群聊邀请码 |
| 历史消息 | GET | /api/groups/{id}/messages | 分页获取历史消息 |

**WebSocket 消息格式**:

```json
// 发送消息
{
  "type": "SEND_MESSAGE",
  "groupId": "xxx",
  "content": "消息内容",
  "replyToId": "被引用消息ID（可选）"
}

// 接收消息
{
  "type": "NEW_MESSAGE",
  "message": {
    "id": "xxx",
    "groupId": "xxx",
    "senderId": "xxx",
    "senderName": "xxx",
    "content": "消息内容",
    "createdAt": "2026-02-05T10:00:00Z",
    "replyTo": { ... }
  }
}
```

**实现要点**:

- 群聊创建时自动生成 6 位邀请码
- 群聊创建时自动添加 AI 成员
- 消息使用 WebSocket 实时推送，延迟目标 < 1秒
- 历史消息分页加载，每页 20 条
<!-- MODIFIED: 原内容为 "Redis 缓存最近 100 条消息，提升读取性能" -->
- **消息缓存策略**：Caffeine 本地缓存最近 100 条消息，Redis 作为二级缓存（仅在本地缓存 miss 时查询）

### 4.3 AI 系统 (AI Module)

**功能**: 提供群聊内的 AI 交互能力

**关联功能**: F-011 AI群成员, F-012 @AI触发回复, F-013 引用AI回复

**技术选型**:

| 组件 | 技术 | 选型理由 |
|------|------|----------|
| AI 服务 | DeepSeek API | 国产服务，¥1/百万tokens，兼容 OpenAI 格式 |
<!-- MODIFIED: 原内容为 "Upstash Redis | Serverless Redis，会话上下文缓存" -->
| 上下文管理 | 消息表直查 | **不使用 Redis 缓存上下文**，直接从 PostgreSQL 查询引用消息，减少 Redis 依赖 |
| 异步处理 | 线程池 | AI 调用异步处理，不阻塞主流程 |

**架构设计**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                          AI Module                                   │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐                                                │
│  │  AIController   │  (内部调用，不对外暴露)                         │
│  └────────┬────────┘                                                │
│           │                                                          │
│           ▼                                                          │
│  ┌─────────────────┐      ┌─────────────────┐                      │
│  │   AIService     │ ───▶ │ ContextBuilder  │                      │
│  │  • @AI 检测     │      │  • 构建上下文   │                      │
│  │  • 触发回复     │      │  • 引用解析     │                      │
│  │  • 引用追问     │      │  • 历史拼接     │                      │
│  └────────┬────────┘      └─────────────────┘                      │
│           │                                                          │
│           ▼                                                          │
│  ┌─────────────────┐      ┌─────────────────┐                      │
│  │  AIApiClient    │ ───▶ │   AI Provider   │                      │
│  │  • API 调用     │      │   (DeepSeek)    │                      │
│  │  • 重试机制     │      │                 │                      │
│  │  • 超时处理     │      │                 │                      │
│  └─────────────────┘      └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────────┘
```

**AI 触发流程**:

```
消息到达 ──▶ 检测是否包含 @AI ──▶ No ──▶ 正常消息处理
                    │
                    ▼ Yes
              提取问题内容
                    │
                    ▼
              构建上下文 ◀── 引用消息（如有）
                    │
                    ▼
              调用 AI API (异步)
                    │
                    ▼
              生成 AI 回复
                    │
                    ▼
              作为群消息广播
```

**实现要点**:

- @AI 检测支持 `@AI`、`@ai`、`@Ai` 等变体
- 引用回复时自动拼接被引用消息作为上下文
- AI 调用异步执行，先返回"正在思考..."提示
- AI 响应超时 30 秒，超时返回友好提示
- 调用频率限制：每用户每分钟 10 次

### 4.4 数据库设计

**ER 图**:

```
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│      users       │       │      groups      │       │     messages     │
│    (用户表)      │       │     (群聊表)     │       │     (消息表)     │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │       │ id (PK)          │
│ email (UNIQUE)   │ 1───n │ name             │ 1───n │ content          │
│ password_hash    │◀─────▶│ invite_code      │◀─────▶│ sender_id (FK)   │
│ nickname         │       │ created_at       │       │ group_id (FK)    │
│ avatar_url       │       │ updated_at       │       │ created_at       │
│ created_at       │       └──────────────────┘       │ message_type     │
│ updated_at       │              │ 1                 │ reply_to_id (FK) │
│ email_verified   │              │                   └──────────────────┘
└──────────────────┘              ▼ n
                         ┌──────────────────┐
                         │  group_members   │
                         │   (群成员表)     │
                         ├──────────────────┤
                         │ id (PK)          │
                         │ group_id (FK)    │
                         │ user_id (FK)     │
                         │ joined_at        │
                         │ is_ai            │
                         └──────────────────┘
```

**索引设计**:

| 表 | 索引 | 字段 | 说明 |
|------|------|------|------|
| users | idx_users_email | email | 登录查询 |
| groups | idx_groups_invite_code | invite_code | 邀请码查询 |
| group_members | idx_gm_group_user | group_id, user_id | 成员关系查询 |
| group_members | idx_gm_user | user_id | 用户群聊列表 |
| messages | idx_msg_group_created | group_id, created_at | 消息时间线查询 |
| messages | idx_msg_reply | reply_to_id | 引用关系查询 |

<!-- NEW START -->
### 4.5 Redis 使用优化策略

**背景**: Upstash 免费版每天仅 10K 请求，需优化架构减少 Redis 依赖。

**优化原则**: 内存优先，Redis 兜底

#### 4.5.1 优化前后对比

| 功能 | 优化前 | 优化后 | Redis 调用减少 |
|------|--------|--------|----------------|
| 在线状态 | Redis 存储 | **JVM 内存 ConcurrentHashMap** | 100% |
| 消息缓存 | Redis 缓存 100 条 | **Caffeine 本地缓存** + Redis 二级 | ~90% |
| AI 上下文 | Redis 缓存会话 | **直接查 PostgreSQL** | 100% |
| 限流计数 | Redis INCR | Redis INCR（保留） | 0% |
| Session | Redis 存储 | JWT 无状态 + Redis 黑名单 | ~80% |

#### 4.5.2 技术实现

**在线状态管理（内存实现）**:
```java
// 使用 ConcurrentHashMap 管理在线状态
@Component
public class OnlineStatusManager {
    private final ConcurrentHashMap<String, Set<String>> groupOnlineUsers = new ConcurrentHashMap<>();

    public void userOnline(String groupId, String userId) { ... }
    public void userOffline(String groupId, String userId) { ... }
    public Set<String> getOnlineUsers(String groupId) { ... }
}
```

**消息缓存（Caffeine + Redis）**:
```java
// 本地缓存优先，Redis 作为二级缓存
@Configuration
public class CacheConfig {
    @Bean
    public Cache<String, List<Message>> messageCache() {
        return Caffeine.newBuilder()
            .maximumSize(100)  // 最多缓存 100 个群的消息
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .build();
    }
}
```

**限流计数（保留 Redis）**:
- 限流是分布式场景必须用 Redis 的功能
- 单用户每分钟 AI 调用限制：10 次
- 预估每日 Redis 调用：~1000 次（100 用户 × 10 次 AI 调用）

#### 4.5.3 Redis 请求量估算

| 场景 | 优化前（每日） | 优化后（每日） |
|------|----------------|----------------|
| 在线状态（10 用户 × 8h × 120 次/h） | 9,600 | 0 |
| 消息缓存（1000 条消息 × 2 次读写） | 2,000 | ~200（10% miss） |
| AI 上下文（100 次 AI 调用 × 3 次） | 300 | 0 |
| 限流计数（100 次 AI 调用） | 100 | 100 |
| Session 验证（1000 次请求） | 1,000 | ~200（仅黑名单检查） |
| **合计** | **~13,000** | **~500** |

**结论**: 优化后 Redis 日请求量从 ~13K 降至 ~500，远低于 Upstash 免费额度（10K/天），**留有 20 倍余量**。

#### 4.5.4 扩展预案

当用户量增长超过免费额度时：
1. **短期**: 升级 Upstash 付费版（$0.2/100K commands，约 $2/月）
2. **中期**: 评估自建 Redis（Railway 支持）
3. **长期**: 考虑多实例部署时引入 Redis Cluster
<!-- NEW END -->

## 5. 风险管理

| 风险 | 可能性 | 影响 | 应对措施 | 负责人 |
|------|--------|------|----------|--------|
<!-- NEW START -->
| Upstash 免费额度耗尽 | 低 | 高 | **已优化架构**：内存优先策略，Redis 日请求量从 ~13K 降至 ~500（详见 4.5 节）；预留升级预算 $2/月 | 后端负责人 |
<!-- NEW END -->
| AI 服务不稳定 | 中 | 高 | 多 AI 提供商备份，降级策略 | 后端负责人 |
| AI 响应延迟 | 中 | 中 | 显示加载状态，设置合理超时 | 后端负责人 |
| 邮箱验证到达率低 | 中 | 高 | 选择可靠服务商，支持重发 | 后端负责人 |
| WebSocket 连接不稳定 | 低 | 中 | 自动重连机制，心跳检测 | 前端负责人 |
| 消息丢失 | 低 | 高 | 消息确认机制，本地缓存 | 全栈 |
| 安全漏洞 | 低 | 高 | 安全审计，渗透测试 | 全栈 |

## 6. 里程碑

```
M1              M2              M3              M4              M5
│               │               │               │               │
▼               ▼               ▼               ▼               ▼
◆───────────────◆───────────────◆───────────────◆───────────────◆
│               │               │               │               │
基础架构        用户系统        群聊系统        MVP发布         v1.1发布
完成            完成            完成            Android        功能增强
```

| 里程碑 | 目标 | 交付物 | 验收标准 |
|--------|------|--------|----------|
| M1 基础架构 | 完成项目搭建和基础设施 | 项目代码库、开发环境、CI/CD | 能本地运行，自动化构建 |
| M2 用户系统 | 完成用户注册登录功能 | 注册/登录接口、前端页面 | 能完成邮箱注册、登录、保持登录态 |
| M3 群聊系统 | 完成群聊和 AI 交互功能 | 群聊功能、AI 对话功能 | 能创建/加入群聊、发消息、@AI 获得回复 |
| M4 MVP 发布 | Android 应用发布 | Google Play 上架 | 应用可下载安装使用 |
| M5 v1.1 发布 | 功能增强版本发布 | 历史消息、邀请码分享 | 功能完善，体验优化 |

## 7. 资源需求

| 角色 | 人数 | 职责 | 参与阶段 |
|------|------|------|----------|
| 后端工程师 | 1-2 | Spring Boot 开发、数据库设计、API 开发 | Phase 1-3 |
| 前端/移动端工程师 | 1-2 | Flutter 开发、UI 实现 | Phase 1-3 |
| 产品经理 | 1 | 需求管理、验收测试 | Phase 1-3 |
| 测试工程师 | 1 | 功能测试、性能测试 | Phase 1-3 |

## 8. 附录

### 8.1 功能-任务映射表

| 功能ID | 功能名称 | 优先级 | 关联任务 |
|--------|----------|--------|----------|
| F-001 | 邮箱注册 | P0 | T-004, T-007 |
| F-002 | 邮箱登录 | P0 | T-005, T-007 |
| F-003 | 登录态管理 | P0 | T-006, T-007 |
| F-004 | 创建群聊 | P0 | T-008, T-011 |
| F-005 | 加入群聊 | P0 | T-008, T-011 |
| F-006 | 群聊列表 | P0 | T-008, T-011 |
| F-007 | 发送消息 | P0 | T-009, T-010, T-011 |
| F-008 | 接收消息 | P0 | T-009, T-010, T-011 |
| F-009 | 历史消息 | P1 | T-018, T-019 |
| F-010 | 邀请码分享 | P1 | T-020, T-021 |
| F-011 | AI群成员 | P0 | T-012, T-015 |
| F-012 | @AI触发回复 | P0 | T-013, T-015 |
| F-013 | 引用AI回复 | P0 | T-014, T-015 |
| F-014 | 主题色 | P2 | T-025, T-026 |
| F-015 | 消息中心 | P2 | T-027, T-028 |

### 8.2 技术决策记录

| 决策 | 选项 | 选择 | 理由 |
|------|------|------|------|
| 移动端框架 | Flutter / React Native / 原生 | Flutter | 跨平台、性能好、开发效率高 |
| 后端框架 | Spring Boot / Node.js / Go | Spring Boot | 生态成熟、团队熟悉 |
| 实时通信 | WebSocket / SSE / Polling | WebSocket | 全双工、低延迟 |
| AI 服务 | OpenAI / Claude / DeepSeek | DeepSeek | 国产服务、性价比高、国内直连、兼容 OpenAI 格式 |
| 数据库 | PostgreSQL / MySQL | Supabase (PostgreSQL) | 托管服务、500MB 免费、自带连接池 |
<!-- MODIFIED: 原内容为 "Serverless、按需计费、10K 请求/天免费" -->
| 缓存 | Redis Cloud / Upstash / 自建 | Upstash + Caffeine | Serverless Redis 作为二级缓存 + 本地 Caffeine 优先，优化后日请求量 ~500（远低于 10K 免费额度） |
| 邮箱服务 | AWS SES / SendGrid / Resend | Resend | API 极简、3000封/月免费、到达率高 |
| 对象存储 | AWS S3 / 阿里云 OSS / R2 | Cloudflare R2 | 10GB 免费、无出口流量费、S3 兼容 |
| 部署平台 | 阿里云 / AWS / Railway | Railway | Git 推送部署、$5/月免费、对新手友好 |
