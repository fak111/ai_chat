# DevelopmentPlan 评审报告

## 概要

| 项目 | 内容 |
|------|------|
| 评审时间 | 2026-02-05 16:45 |
| 目标文档 | doc/DevelopmentPlan.md |
| 参照文档 | doc/FeatureSummary.md |
| 问题统计 | 1 个严重 / 3 个一般 / 5 个建议 |
| 文档版本 | v1.1 (技术选型已确定) |

## 功能覆盖分析

| FeatureSummary 功能 | DevelopmentPlan 对应 | 状态 |
|---------------------|----------------------|------|
| F-001 邮箱注册 | T-004, T-007 | ✅ |
| F-002 邮箱登录 | T-005, T-007 | ✅ |
| F-003 登录态管理 | T-006, T-007 | ✅ |
| F-004 创建群聊 | T-008, T-011 | ✅ |
| F-005 加入群聊 | T-008, T-011 | ✅ |
| F-006 群聊列表 | T-008, T-011 | ✅ |
| F-007 发送消息 | T-009, T-010, T-011 | ✅ |
| F-008 接收消息 | T-009, T-010, T-011 | ✅ |
| F-009 历史消息 | T-018, T-019 | ✅ |
| F-010 邀请码分享 | T-020, T-021 | ✅ |
| F-011 AI群成员 | T-012, T-015 | ✅ |
| F-012 @AI触发回复 | T-013, T-015 | ✅ |
| F-013 引用AI回复 | T-014, T-015 | ✅ |
| F-014 主题色 | T-025, T-026 | ✅ |
| F-015 消息中心 | T-027, T-028 | ✅ |

**覆盖率**: 15/15 = 100% ✅

**分析**: 所有功能均有对应的开发任务覆盖，功能-任务映射表（8.1章节）与 FeatureSummary 完全对应，任务依赖关系清晰。

## 技术风险分析

| 风险项 | 影响范围 | 严重程度 | 建议措施 |
|--------|----------|----------|----------|
| Upstash 免费额度限制 (10K/天) | 实时聊天、缓存、在线状态 | 高 | 详见 C-001，需评估实际 QPS 并制定应对方案 |
| Supabase 存储限制 (500MB) | 消息持久化、用户数据 | 中 | 消息表增长较快，需规划数据归档策略 |
| DeepSeek API 稳定性 | AI 交互功能 | 中 | 国产新兴服务，需准备备选方案 |
| Railway $5 免费额度 | 服务部署 | 中 | WebSocket 长连接消耗资源较高，需监控用量 |
| 单点故障风险 | 整体服务 | 低 | MVP 阶段可接受，后续需考虑高可用 |

## 问题清单

### 严重问题 (Critical)

**C-001**: Upstash 免费额度可能无法支撑实时聊天场景

- 位置：`doc/DevelopmentPlan.md:31`
- 描述：Upstash 免费版每天仅 10K 请求。根据架构设计，Redis 承担以下职责：
  - Session 存储
  - 消息缓存（最近 100 条）
  - 在线状态管理
  - 限流计数

  假设 WebSocket 心跳 30 秒/次，每次更新在线状态需 1 次 Redis 操作，则单用户每小时产生 120 次请求。加上消息缓存读写、Session 验证等，**10 个活跃用户即可能在 8 小时内耗尽配额**。

- 建议：
  1. 将在线状态管理改为内存实现，减少 Redis 依赖
  2. 消息缓存改用本地缓存 + Redis 回源模式
  3. 或预留 Upstash 付费预算（按需计费 $0.2/100K commands）
  4. 添加 Redis 请求量监控，提前预警

### 一般问题 (Major)

**M-001**: AI 服务降级策略缺少实现细节

- 位置：`doc/DevelopmentPlan.md:619`
- 描述：风险管理中提到"多 AI 提供商备份，降级策略"，但技术方案（4.3 AI系统）中未说明：
  - 备选 AI 服务商是什么
  - 何时触发切换（超时次数？错误率？）
  - 配置如何管理
- 建议：在 AI 模块技术方案中补充降级策略实现细节，推荐备选服务商：OpenAI（兼容格式）或通义千问

**M-002**: 数据库存储容量规划缺失

- 位置：`doc/DevelopmentPlan.md:30`
- 描述：Supabase 免费版仅 500MB。假设单条消息平均 500 字节，500MB 仅支持约 100 万条消息。若日均消息量 1 万条，约 100 天达到上限。
- 建议：
  1. 在文档中估算消息增长速度
  2. 制定数据归档策略（如仅保留近 90 天消息）
  3. 明确触发升级的数据量阈值

**M-003**: 测试策略描述不足

- 位置：`doc/DevelopmentPlan.md:262`
- 描述：T-016 集成测试仅简单描述为"端到端测试、性能测试"，未明确：
  - 测试用例范围和编写规范
  - 性能测试指标（如并发用户数、响应时间）
  - 自动化测试覆盖率要求
- 建议：补充测试策略，明确 MVP 上线的测试标准

### 改进建议 (Minor)

**N-001**: 建议补充监控告警方案

- 位置：全文
- 描述：未提及生产环境监控方案（日志、指标、告警）
- 建议：MVP 阶段建议至少集成：
  - Railway 自带监控
  - Sentry 错误追踪（免费 5K 事件/月）
  - Supabase 自带的数据库监控

**N-002**: 邮箱验证失败的用户体验可细化

- 位置：`doc/DevelopmentPlan.md:407`
- 描述：提到"验证链接有效期 24 小时，支持重发"
- 建议补充：
  - 验证邮件重发的冷却时间（建议 60 秒）
  - 每日重发次数限制（防滥用）

**N-003**: WebSocket 断线重连策略建议明确

- 位置：`doc/DevelopmentPlan.md:623`
- 描述：提到"自动重连机制"，建议明确：
  - 重连间隔策略（推荐指数退避：1s → 2s → 4s → 8s → 最大 30s）
  - 最大重试次数或超时
  - 重连成功后的消息补偿机制

**N-004**: 数据库 ER 图缺少验证码表

- 位置：`doc/DevelopmentPlan.md:577-603`
- 描述：邮箱验证流程需要存储验证 Token，但 ER 图中未包含相关表
- 建议：补充 `email_verifications` 表设计（token, user_id, expires_at, used）

**N-005**: 技术栈版本建议具体化

- 位置：`doc/DevelopmentPlan.md:25-35`
- 描述：Flutter 3.x、Spring Boot 3.x 版本号过于宽泛
- 建议：在开发启动前锁定具体版本（如 Flutter 3.19.x、Spring Boot 3.2.x）以避免兼容性问题

## 评审结论

**需修改后通过**

开发计划整体结构完整，功能覆盖全面，技术选型合理（DeepSeek、Resend、Cloudflare R2、Supabase、Upstash 均为成本友好的选择）。

**主要优点**：
- 功能-任务映射完整，100% 覆盖 FeatureSummary
- 三阶段划分合理（MVP → 功能增强 → 平台扩展）
- 技术方案详细，包含架构图、接口设计、实现要点
- 技术选型已完成，成本控制合理

**主要关注点**：
- **必须处理**: Upstash 免费额度限制（C-001），可能导致实时聊天功能在用户量稍多时失效
- **建议处理**: AI 降级策略、数据库容量规划、测试策略

### 下一步行动

- [ ] **[关键]** 评估 Upstash 实际请求量，制定应对方案（优化架构或预留预算）
- [ ] 在 AI 模块技术方案中补充备选服务商和切换机制
- [ ] 补充数据库容量规划和归档策略
- [ ] 细化 T-016 测试任务，明确测试范围和标准
- [ ] 补充 `email_verifications` 表设计
- [ ] （可选）补充监控告警方案

---

*评审完成后，建议运行 `/md` 根据以上问题修改 DevelopmentPlan.md*
