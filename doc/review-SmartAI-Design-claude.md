# SmartAI-Design 评审报告

## 概要

| 项目 | 内容 |
|------|------|
| 评审时间 | 2026-02-19 12:50 |
| 目标文档 | doc/chat/pi/SmartAI-Design.md |
| 文档版本 | v1.0（首版梗概） |
| 问题统计 | 3 个严重 / 4 个一般 / 3 个建议 |

## 问题清单

### 严重问题 (Critical)

> 必须修复，否则影响后续开发

1. **[全局] 缺少功能需求的明确边界和验收标准**
   - 现状：三大核心能力（记忆、工具调用、工具创造）只有一句话描述，没有用户故事、验收标准或 MVP 范围界定
   - 建议：每个能力需要至少定义：
     - 用户故事（作为群聊用户，我希望...）
     - MVP 范围（v1 做什么，不做什么）
     - 验收标准（怎样算"做完了"）

2. **[第2节] Java ↔ Node.js 通信契约未定义**
   - 现状：架构图画了 `HTTP/WS` 连线，第4节给了一个示例请求/响应，但没有正式的 API 契约
   - 影响：Java 侧 `AIService.java` 的改造无法开始，前后端无法并行开发
   - 建议：定义最小 API 契约，至少包含：
     - `POST /chat` 的请求体/响应体 schema
     - 错误码定义
     - 超时和重试策略（当前 AIService 的 RestTemplate 已配超时）
     - 流式 vs 非流式的选择

3. **[第3节] 沙盒安全方案完全缺失**
   - 现状："工具创造"声称 Agent 能写代码生成新工具并在沙盒执行，但未说明任何安全约束
   - 风险：这是**服务器端代码执行**，直接暴露在生产环境，安全风险极高
   - 建议：必须在下一版定义：
     - 沙盒隔离级别（Docker-in-Docker? gVisor? 独立网络?）
     - 资源限制（CPU/内存/磁盘/网络/执行时间）
     - 能力白名单（允许调用哪些 API，禁止什么）
     - 工具审核机制（AI 造的工具谁来审批？自动还是人工？）

### 一般问题 (Major)

> 建议修复，可提升文档质量

1. **[第3节] 记忆系统数据模型未定义**
   - 现状：只说"跨会话记忆，群维度持久化"，未说明记忆存什么、怎么存、怎么检索
   - 建议：明确：
     - 记忆粒度：群级别？用户级别？消息级别？
     - 存储方式：PostgreSQL 新表？向量数据库？Redis？
     - 检索策略：关键词？语义搜索？时间窗口？
     - 与现有 `contextWindowMinutes`/`contextMaxMessages` 配置的关系

2. **[第2节] Pi Agent 依赖版本和包管理未说明**
   - 现状：引用了 `@mariozechner/pi-agent-core` 等包，但未说明：
     - 使用哪个版本（迁移指南中写的 `^0.52.9` 是否最新）
     - 包是从 npm 安装还是本地 monorepo
     - Node.js 版本要求
   - 建议：明确依赖清单和安装方式

3. **[第4节] 流式响应未考虑**
   - 现状：通信流程是同步 request-response 模式，但 Pi Agent 的核心优势之一是**流式事件驱动**
   - 影响：用户体验——等 Agent 执行完工具链再返回可能要 10+ 秒，前端无反馈
   - 建议：评估是否需要 SSE/WebSocket 流式推送 Agent 的中间状态（"正在搜索..."、"正在执行工具..."）

4. **[全局] 与现有系统的兼容性/降级策略缺失**
   - 现状：未说明迁移期间如何处理：
     - Agent 服务宕机时的降级（回退到当前 DeepSeek 直连？）
     - 现有 `@AI` 触发机制是否保留
     - 数据迁移（现有消息历史是否需要导入记忆系统）
   - 建议：定义降级策略和灰度方案

### 改进建议 (Minor)

> 可选优化项

1. **[第2节] 端口号 3001 建议加入配置说明**
   - 建议：在 docker-compose 集成时通过环境变量配置，避免硬编码

2. **[第5节] 迭代计划缺少时间线和优先级**
   - 现状：列了 v1.1~v1.5 但未标注优先级和依赖关系
   - 建议：标注哪些是 blocking（如 API 契约 blocks 所有开发），哪些可并行

3. **[全局] 缺少性能指标和 SLA**
   - 建议：定义关键指标：
     - Agent 响应延迟目标（当前 AIService 无 SLA，迁移后应设定）
     - 内存占用预算（Node.js 侧车的资源限制）
     - 并发处理能力（多群同时 @AI 的场景）

## 评审结论

**需修改后通过**

作为首版梗概，架构方向和核心理念清晰，侧车方案的选型理由充分。但作为可执行的设计文档，缺少关键的 API 契约、安全方案和验收标准。建议按优先级补充后进入下一轮评审。

### 下一步行动

- [ ] **P0** 定义 Java ↔ Node.js API 契约（request/response schema）
- [ ] **P0** 补充沙盒安全方案（隔离级别、资源限制、能力白名单）
- [ ] **P1** 设计记忆系统数据模型（存储、检索、与现有上下文机制的关系）
- [ ] **P1** 明确降级策略（Agent 服务不可用时的 fallback）
- [ ] **P2** 评估流式响应方案
- [ ] **P2** 补充迭代计划的优先级和依赖关系
