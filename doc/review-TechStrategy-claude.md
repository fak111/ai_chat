# 技术选型文档评审报告

## 概要

| 项目 | 内容 |
|------|------|
| 评审时间 | 2026-02-20 |
| 目标文档 | doc/chat/product/now.md (A宝技术建设选型 v1.1) |
| 参照文档 | doc/PRD.md v1.0, doc/RequirementsDoc.md, doc/market/marketing-plan.md |
| 问题统计 | 3 个严重 / 4 个一般 / 3 个建议 |

---

## 一致性检查

### 与 PRD 需求覆盖分析

| PRD 需求项 | now.md 对应位置 | 状态 |
|-----------|----------------|------|
| F-001 邮箱注册 | 无涉及 | ⬜ 不相关（已完成功能，选型文档不需要覆盖） |
| F-002 邮箱登录 | 无涉及 | ⬜ 不相关 |
| F-003 登录态管理 | 无涉及 | ⬜ 不相关 |
| F-004 创建群聊 | 无涉及 | ⬜ 不相关 |
| F-005 加入群聊 | 无涉及 | ⬜ 不相关 |
| F-006 群聊列表 | 无涉及 | ⬜ 不相关 |
| F-007 发送消息 | 改动1(断线重连) + 改动2(ACK) | ✅ 已覆盖 |
| F-008 接收消息 | 改动1 + 改动2 | ✅ 已覆盖 |
| F-009 历史消息 (P1) | 改动5(上拉加载) | ✅ 已覆盖 |
| F-010 邀请码分享 (P1) | 无涉及 | ⬜ 不相关 |
| F-011 AI 群成员 | 改动4(AI视觉身份) | ✅ 已覆盖 |
| F-012 @AI 触发回复 | 第六章已标记 AI 流式回复已完成 | ✅ 已覆盖 |
| F-013 引用 AI 回复 | 改动3(消息引用模型升级) | ✅ 已覆盖 |
| F-014 主题色 (P2) | 无涉及 | ⬜ 不相关 |
| PRD 非功能：消息延迟 < 1s | 改动1(断线重连) 间接改善 | ⚠️ 部分覆盖 |
| PRD 非功能：AI 响应 < 5s | 已完成流式输出 | ✅ 已覆盖 |
| PRD 非功能：安全需求(HTTPS/密码哈希) | 第六章明确"别抄 Signal E2EE" | ⚠️ 需注意：没有否定基本安全，但措辞上可能造成误读 |

### 与营销方案(marketing-plan.md)的一致性

| 营销定位 | now.md 对应 | 状态 |
|---------|------------|------|
| "AI 不是客服，是群友" | 改动4(AI视觉身份) 直接支撑 | ✅ 一致 |
| "有记忆" | 路线图提到"AI 记忆持久化"（远期） | ⚠️ 营销强调但技术建设排在远期 |
| "有态度" | 第六章提到 soul.md 人格，但无落地改动 | ⚠️ 未覆盖 |
| "有品味，极简设计" | 第六章"学 Telegram 极简 UI" | ✅ 一致 |
| "AI Native" | 第六章核心结论提到 | ✅ 一致 |

### 差异说明

now.md 中有多项 PRD/RequirementsDoc **未提及**的技术建设：

| 新增项 | 来源说明 |
|--------|---------|
| 多端同步 | PRD 未提（MVP 单端），now.md 列为"下一步" — **合理前瞻** |
| 消息 ACK 机制 | PRD 未提，now.md 改动2 — **技术层面的必要补充** |
| 线程(Thread)概念 | PRD 只有"引用"，now.md 提到 Matrix 线程 — **合理预留但需标注为远期** |
| 自托管架构预留 | PRD/营销均未提 — **过度前瞻，P3 标注合理** |
| 离线消息 + 推送 | PRD 4.4 写"待定"，now.md 列为"下一步" — **正确补位** |

---

## 问题清单

### 严重问题 (Critical)

> 必须修复，否则影响技术决策正确性

**1. [now.md:278] "已读回执"列为 P2 但与产品定位冲突**

- 现状：第六章将 iMessage 的"已读回执 + 正在输入"列为 P2 吸收项
- 问题：**已读回执在群聊场景中是社交压力源**。A宝 定位熟人群聊，已读回执会让人"不敢不回"，与"轻松、有态度"的调性矛盾。Telegram 的群聊也**没有**已读回执（只有私聊的双蓝勾）
- 建议：将"已读回执"从吸收项中**删除**或降为 P4。"正在输入"指示器可以保留（AI 正在思考的提示是好体验）

**2. [now.md:342-372] 改动1 断线重连方案描述有技术误区**

- 现状：写"断线期间如果用户发了消息（走 HTTP POST），WS 广播丢失 → 其他人看不到"
- 问题：**这是错误的**。发消息走 HTTP POST → 服务端 INSERT 数据库 → `broadcastToGroup()` 通过 WS 推送给**所有在线成员**。只有**发送者自己**因为 WS 断了收不到广播回显，但其他在线成员会正常收到。真正的问题是：**接收方断线期间的消息丢失**（没人给断线用户推送）
- 建议：修正问题描述。重点是"接收方断线后如何补齐缺失消息"，不是"发送方的消息其他人看不到"

**3. [now.md 第七章整体] 5 个改动中缺少 PRD 营销最强调的"记忆"能力落地方案**

- 现状：营销方案三大卖点是"有记忆、有态度、有品味"，now.md 把"AI 记忆持久化"放在远期路线图
- 问题：**后端已经实现了 memory-manager.ts（永久记忆 + 会话历史）**，但文档完全没有提到如何让用户**感知到** AI 有记忆。技术建设不等于产品体验
- 建议：增加一个改动项——"AI 记忆感知化"：
  - 当 AI 引用过去的对话时，前端用特殊样式标注（如"回忆气泡"）
  - 或者 AI 消息中带 `memoryRef` 字段，前端渲染"记住了 X 天前你说的..."

---

### 一般问题 (Major)

> 建议修复，可提升文档质量

**4. [now.md:1-9] 文档缺少与上游文档的关联声明**

- 现状：文档头部只有 title/version/author，没有说明它在文档链中的位置
- 建议：头部增加 `参照文档: PRD.md v1.0, marketing-plan.md v1.0`

**5. [now.md:263] 第六章产品灵魂描述与 PRD 定位措辞不一致**

- 现状：now.md 写"有记忆、有态度、会接梗"，PRD 写"将 AI 助手融入熟人群聊，让每个群都拥有智能伙伴"
- 问题：now.md 的描述来自 marketing-plan.md 而非 PRD，两者语气差异大（PRD 偏正式，营销偏活泼）
- 建议：明确标注该定位来源于营销方案而非 PRD，或者更新 PRD 使两者对齐

**6. [now.md:376-421] 改动2 的 ACK 机制与改动1 有功能重叠**

- 现状：改动1 用 `since` 时间戳拉差量，改动2 用 ACK 的 `lastAckedMessageId` 拉差量
- 问题：两个机制解决同一个问题（断线补消息），会造成实现冲突
- 建议：合并为一个方案。推荐**只用 ACK 方案**（更精确），`since` 时间戳做降级兜底

**7. [now.md:585-595] 工作量估算偏乐观**

- 现状：改动1(断线重连) 6h、改动2(ACK) 8h
- 问题：断线重连涉及前后端联调 + 各种边界情况（弱网、token 过期、多次断连），6h 偏紧。ACK 涉及新的存储层（lastAckedMessage 存哪？内存 / Redis / DB?），8h 也偏紧
- 建议：改动1 估 8-12h，改动2 估 12-16h，含测试

---

### 改进建议 (Minor)

> 可选优化项

**8. [now.md 一至五章] 前 5 章通用 IM 分析篇幅过长**

- 现状：第一至五章（~250 行）是 Telegram/Matrix/Signal 的通用分析，第六七章（~270 行）才是 A宝 专属内容
- 建议：前 5 章浓缩为一个对比表格（20 行），或拆分为独立文档 `im-landscape.md`，让 `now.md` 聚焦于 A宝 自身的技术决策

**9. [now.md:291] "别抄 Telegram 的超大群"应给出群上限建议**

- 现状：写"A宝 的场景是 3-20 人熟人群"，但没有明确的技术限制
- 建议：在落地方案中增加群人数上限配置（建议 50 人），这直接影响 AI 上下文窗口的设计

**10. [now.md:496-539] 改动4 AI 视觉身份缺少 AI 头像资源**

- 现状：方案写 `avatarUrl: '/assets/abao-avatar.png'`，但项目中不存在此文件
- 建议：在实施前需要设计 AI 头像。建议先用一个简单的紫色渐变圆形 + "A" 字母作为 placeholder

---

## 评审结论

**需修改后通过**

**结论说明**：
- 文档整体质量高，从源码级调研到代码映射的思路扎实
- 第六章"该抄谁/别抄谁"的分析与产品定位高度一致
- 第七章的 5 个落地方案可操作性强，优先级排序合理
- 但存在 3 个严重问题需要修正：已读回执的产品判断、断线重连的技术描述、以及"记忆"这个核心卖点缺少落地方案

### 下一步行动

- [ ] **Critical #1**: 删除已读回执或降为 P4，保留"AI 正在思考"指示器
- [ ] **Critical #2**: 修正改动1的问题描述（接收方断线丢消息，不是发送方）
- [ ] **Critical #3**: 增加"AI 记忆感知化"落地方案（改动6），这是营销最强调的卖点
- [ ] **Major #6**: 合并改动1和改动2为统一的"消息可靠投递"方案
- [ ] **Minor #8**: 考虑将前 5 章拆分为独立文档，让 now.md 更聚焦
