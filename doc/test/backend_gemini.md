# 后端测试规范

本文档旨在统一和规范后端服务的测试策略，确保代码质量、功能稳定性和系统可靠性。

## 一、现有测试体系

通过对项目 `build.gradle.kts` 和现有测试结构的分析，我们当前的测试体系总结如下：

### 1. 技术栈

- **核心框架**: Spring Boot
- **测试运行器**: JUnit 5 (通过 `spring-boot-starter-test` 引入)
- **断言库**: AssertJ (通过 `spring-boot-starter-test` 引入)
- **Mocking框架**: Mockito (通过 `spring-boot-starter-test` 引入)
- **数据库测试**: H2 In-Memory Database
- **安全测试**: Spring Security Test

### 2. 测试分类

当前项目中的测试主要可以归为两类：

- **单元测试 (Unit Tests)**: 针对单个类或方法进行测试，使用 Mockito 隔离外部依赖（如 Service、Repository）。
- **集成测试 (Integration Tests)**: 启动一个完整的 Spring Boot 应用上下文进行测试，验证多个组件（如 Controller, Service, Repository）协同工作的正确性。使用 H2 内存数据库替代真实的 PostgreSQL，以实现测试环境的隔离和快速执行。

---

## 二、未来演进：构建稳固的测试金字塔

为了构建一个更健壮、更高效、更可靠的测试体系，我们应遵循经典的“测试金字塔”模型，并引入更先进的测试工具和策略。

### 1. 测试金字塔模型

我们的目标是建立一个由三层组成的测试结构：

- **单元测试 (70%)**: 构成金字塔的基础。它们运行速度快，反馈迅速，用于验证最小代码单元（方法、类）的逻辑正确性。
- **集成测试 (20%)**: 位于金字塔的中间层。用于验证模块之间、服务与数据库/缓存等外部依赖之间的交互是否正确。
- **端到端测试 (E2E Tests) (10%)**: 位于金字塔的顶层。模拟真实用户场景，贯穿整个应用流程，确保系统在真实环境中的行为符合预期。

### 2. 未来技术栈与策略

#### a. 单元测试 (Unit Tests)

- **目标**: 保持高覆盖率和高执行速度。
- **策略**:
    - **严格隔离**: 坚持使用 Mockito 隔离所有外部依赖（其他服务、数据库、缓存、消息队列等）。
    - **覆盖核心逻辑**: 重点覆盖业务逻辑复杂、容易出错的分支和边界条件。
    - **工具**: 继续沿用 **JUnit 5 + Mockito + AssertJ** 的黄金组合。

#### b. 集成测试 (Integration Tests)

- **目标**: 验证服务内部模块间以及与外部中间件的协同工作。
- **策略**:
    - **引入 Testcontainers**: 逐步放弃 H2 数据库，全面转向 **Testcontainers**。
        - **优势**: Testcontainers 可以在 Docker 容器中启动真实的依赖服务（如 PostgreSQL, Redis），使测试环境与生产环境高度一致，避免 H2 与 PostgreSQL 方言不兼容导致的问题。
        - **实践**: 为 PostgreSQL, Redis 等关键依赖创建可复用的 Testcontainer 配置，确保测试的稳定性和效率。
    - **分层测试**:
        - **Repository/DAO层**: 测试与真实数据库（由 Testcontainers 提供）的交互，验证 SQL 查询和数据访问逻辑。
        - **Service层**: 测试业务逻辑，此时可以 Mock 掉外部 HTTP 调用，但与真实的数据库和缓存容器交互。
        - **Controller层**: 使用 `@SpringBootTest` 配合 `MockMvc`，模拟 HTTP 请求，验证 API 的端点、参数校验、返回格式和状态码，但不启动完整的Web服务器。

#### c. 端到端测试 (E2E Tests)

- **目标**: 模拟真实用户，验证完整的业务流程。
- **策略**:
    - **独立测试模块**: 在 `server` 目录下创建一个新的 `e2e` 或 `system-test` 测试模块，与主代码库隔离。
    - **工具**: 使用 **RestAssured** 或 **Karate** 框架。
        - **RestAssured**: 强大的 Java DSL，用于简化和验证 REST API 测试。
        - **Karate**: 功能更全面的测试框架，支持 API 测试、Mock，甚至可以进行简单的 UI 自动化，使用 Gherkin 语法（Given-When-Then），便于非开发人员理解。
    - **测试环境**: E2E 测试应针对一个 **预部署（Staging）环境** 运行，该环境拥有与生产环境几乎一致的基础设施。测试应覆盖核心用户场景，例如：用户注册 -> 登录 -> 创建群组 -> 发送消息 -> AI回复。

### 3. CI/CD 集成

- **持续集成 (CI)**:
    - **Pull Request 触发**: 在每次提交 Pull Request 时，自动运行所有 **单元测试** 和 **集成测试**。
    - **构建失败**: 如果任何测试失败，CI 流水线应立即中断，并阻止代码合并。
- **持续部署 (CD)**:
    - **部署到Staging后触发**: 在代码成功部署到 Staging 环境后，自动触发 **端到端测试**。
    - **部署到生产**: 只有当所有 E2E 测试通过后，才允许或触发向生产环境的部署。

通过以上规划，我们可以建立一个层次分明、关注点分离、自动化程度高的测试体系，为应用的长期稳定发展提供坚实保障。
